#!/bin/bash

DATE="$1"   # e.g., 2025-08-04

if [[ -z "$DATE" ]]; then
  echo "Usage: $0 <date: YYYY-MM-DD>"
  exit 1
fi

# Paths
SERVICE_LOGS="/local/armdata/selius20*/logs/archived/artifactory-service.${DATE}*"
REQUEST_LOGS="/local/armdata/selius20*/logs/archived/artifactory-request.${DATE}*"

OUTPUT_FILE="repo_ip_user_${DATE}.csv"

echo "Repo Name,Count,IP+Username List" > "$OUTPUT_FILE"

# Step 1: Get repo names and counts from service logs
zgrep "should be a repo request" $SERVICE_LOGS 2>/dev/null \
  | sed -E 's/.*Request \/(.+?)\//\1/' \
  | sort | uniq -c | sort -nr \
  | while read count repo; do
      # Step 2: Collect unique IP+Username for the repo
      ip_user_list=$(zgrep "$repo" $REQUEST_LOGS 2>/dev/null \
        | awk -F' ' '{print $3 " (" $4 ")"}' \
        | sort -u \
        | tr '\n' '; ' \
        | sed 's/; $//')  # Remove trailing semicolon

      # Step 3: Output in CSV format
      echo "$repo,$count,\"$ip_user_list\"" >> "$OUTPUT_FILE"
    done

echo "âœ… Aggregated output saved to $OUTPUT_FILE (Excel-friendly CSV)"
